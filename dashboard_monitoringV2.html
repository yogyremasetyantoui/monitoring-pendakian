/**
 * ===============================================
 * ðŸŒ Dashboard Monitoring Pendakian (Final Sync)
 * ===============================================
 * Endpoint: ?dashboard=true
 * - Aman (tanpa NIK/email/phone)
 * - Menyertakan prediksi arah naik/turun
 * - Menghasilkan field untuk 9 pos dan prediksi berikutnya
 * - Sinkron dengan tampilan dashboard_monitoring.html
 */
function doGetDashboard(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet =
    ss.getSheetByName("DataPendaki") ||
    ss.getSheetByName("DaftarPendaki");
  if (!sheet) throw new Error("Sheet DataPendaki/DaftarPendaki tidak ditemukan");

  const data = sheet.getDataRange().getValues();
  const headers = data.shift();
  const json = [];

  data.forEach((row, rIndex) => {
    if (row.join("").trim() === "") return;

    const obj = {};
    headers.forEach((h, i) => (obj[h] = row[i]));

    // Cari pos terakhir yang memiliki waktu
    let lastPos = null;
    let lastTime = null;
    for (let i = 9; i >= 1; i--) {
      const t = obj[`timePos${i}`];
      if (t && t.toString().trim() !== "") {
        lastPos = i;
        lastTime = new Date(t);
        break;
      }
    }

    const lastStatus = lastPos ? obj[`StatPos${lastPos}`] || "" : "";
    obj["LatestStatus"] = lastStatus;
    obj["LatestActivity"] = lastTime ? lastTime.toISOString() : "";

    // Deteksi arah naik/turun
    const isNaik =
      /NAIK|SUMMIT|REST|CAMPING/i.test(lastStatus) &&
      !/TURUN|EXIT/i.test(lastStatus);
    const isTurun = /TURUN|EXIT/i.test(lastStatus);

    // Hitung prediksi pos berikutnya
    let nextPos = null;
    if (lastPos && lastTime) {
      if (isNaik && lastPos < 9) nextPos = lastPos + 1;
      else if (isTurun && lastPos > 1) nextPos = lastPos - 1;

      if (nextPos) {
        const deltaMinutes = isNaik ? 45 : 30; // waktu estimasi antar pos
        const predicted = new Date(lastTime.getTime() + deltaMinutes * 60000);

        // Simpan hasil prediksi
        obj[`PredPos${nextPos}`] = predicted.toISOString();
        obj["NextPosNumber"] = nextPos;
        obj["NextPosDirection"] = isNaik ? "UP" : "DOWN";
        obj["NextPosPrediction"] = predicted.toISOString();

        // Simpan ke sheet bila kolom PredPosX kosong
        const colIndex = headers.indexOf(`PredPos${nextPos}`);
        if (colIndex !== -1 && !row[colIndex]) {
          sheet.getRange(rIndex + 2, colIndex + 1).setValue(predicted);
        }
      }
    }

    // Siapkan data aman untuk dikirim
    const safeData = {
      date: obj.date || "",
      groupname: obj.groupname || "",
      hikername: obj.hikername || "",
      uniqueid: obj.uniqueid || "",
      LatestStatus: obj.LatestStatus || "",
      LatestActivity: obj.LatestActivity || "",
      NextPosNumber: obj.NextPosNumber || "",
      NextPosDirection: obj.NextPosDirection || "",
      NextPosPrediction: obj.NextPosPrediction || ""
    };

    // Tambahkan status dan waktu untuk 9 pos
    for (let i = 1; i <= 9; i++) {
      safeData[`StatPos${i}`] = obj[`StatPos${i}`] || "";
      safeData[`timePos${i}`] = obj[`timePos${i}`] || "";
      safeData[`PredPos${i}`] = obj[`PredPos${i}`] || "";
    }

    json.push(safeData);
  });

  return ContentService.createTextOutput(
    JSON.stringify({
      success: true,
      timestamp: new Date().toISOString(),
      total: json.length,
      data: json
    })
  ).setMimeType(ContentService.MimeType.JSON);
}
