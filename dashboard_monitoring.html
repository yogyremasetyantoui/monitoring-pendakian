<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Monitoring Pendakian</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f2f5;
      padding: 20px;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }
    .header p {
      opacity: 0.9;
      font-size: 14px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-left: 4px solid #667eea;
    }
    .stat-card.warning {
      border-left-color: #ffc107;
    }
    .stat-card.danger {
      border-left-color: #dc3545;
    }
    .stat-card.success {
      border-left-color: #28a745;
    }
    .stat-number {
      font-size: 36px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }
    .stat-label {
      color: #6c757d;
      font-size: 14px;
    }
    .controls {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    .search-box {
      flex: 1;
      min-width: 250px;
    }
    .search-box input {
      width: 100%;
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }
    .search-box input:focus {
      outline: none;
      border-color: #667eea;
    }
    .filter-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    .filter-btn.active {
      background: #667eea;
      color: white;
    }
    .filter-btn:not(.active) {
      background: #e0e0e0;
      color: #666;
    }
    .filter-btn:hover {
      transform: translateY(-2px);
    }
    .refresh-btn {
      background: #28a745;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    .refresh-btn:hover {
      background: #218838;
    }
    .table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th {
      background: #667eea;
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    td {
      padding: 12px 15px;
      border-bottom: 1px solid #e0e0e0;
    }
    tr:hover {
      background: #f8f9fa;
    }
    .status-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 11px;
      font-weight: bold;
    }
    .status-naik { background: #d4edda; color: #155724; }
    .status-rest { background: #fff3cd; color: #856404; }
    .status-camping { background: #d1ecf1; color: #0c5460; }
    .status-summit { background: #e2d9f3; color: #6f42c1; }
    .status-exit { background: #e2e3e5; color: #383d41; }
    .status-turun { background: #ffeaa7; color: #d63031; }
    .status-sos { 
      background: #f8d7da; 
      color: #721c24;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0%, 50%, 100% { opacity: 1; }
      25%, 75% { opacity: 0.6; }
    }
    .pos-tracker {
      display: flex;
      gap: 5px;
      align-items: center;
    }
    .pos-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #e0e0e0;
    }
    .pos-dot.active {
      background: #28a745;
      box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
    }
    .loading {
      text-align: center;
      padding: 50px;
      color: #667eea;
      font-size: 18px;
    }
    .no-data {
      text-align: center;
      padding: 50px;
      color: #999;
    }
    .time-info {
      font-size: 11px;
      color: #999;
    }
    .export-btn {
      background: #17a2b8;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    .export-btn:hover {
      background: #138496;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìä Dashboard Monitoring Pendakian</h1>
    <p>Real-time tracking semua pendaki ‚Ä¢ Update otomatis setiap 30 detik</p>
  </div>

  <div class="stats-grid" id="statsGrid">
    <div class="stat-card">
      <div class="stat-number" id="totalPendaki">-</div>
      <div class="stat-label">Total Pendaki</div>
    </div>
    <div class="stat-card success">
      <div class="stat-number" id="diJalur">-</div>
      <div class="stat-label">Sedang di Jalur</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="puncak">-</div>
      <div class="stat-label">Mencapai Puncak</div>
    </div>
    <div class="stat-card warning">
      <div class="stat-number" id="istirahat">-</div>
      <div class="stat-label">Istirahat/Camping</div>
    </div>
    <div class="stat-card danger">
      <div class="stat-number" id="sos">-</div>
      <div class="stat-label">‚ö†Ô∏è SOS Emergency</div>
    </div>
  </div>

  <div class="controls">
    <div class="search-box">
      <input type="text" id="searchBox" placeholder="üîç Cari nama pendaki atau NIK...">
    </div>
    <button class="filter-btn active" data-filter="all">Semua</button>
    <button class="filter-btn" data-filter="active">Aktif di Jalur</button>
    <button class="filter-btn" data-filter="sos">üÜò SOS</button>
    <button class="refresh-btn" onclick="loadData()">üîÑ Refresh</button>
    <button class="export-btn" onclick="exportToCSV()">üì• Export CSV</button>
  </div>

  <div class="table-container">
    <div class="loading" id="loading">‚è≥ Memuat data...</div>
    <div class="no-data" id="noData" style="display:none;">
      üì≠ Belum ada data pendaki
    </div>
    <table id="dataTable" style="display:none;">
      <thead>
        <tr>
          <th>Nama Pendaki</th>
          <th>NIK</th>
          <th>Kelompok</th>
          <th>Progress Pos</th>
          <th>Status Terakhir</th>
          <th>Waktu Terakhir</th>
          <th>Unique ID</th>
        </tr>
      </thead>
      <tbody id="tableBody">
      </tbody>
    </table>
  </div>

  <script>
    // PILIH SALAH SATU METHOD:
    
    // METHOD 1: Langsung dari Google Sheets (Sheet harus public)
    const USE_DIRECT_SHEETS = false;
    const SHEET_ID = '1ewlfCWKiY72wkWh_GqtuEf1A1xWtcsw6stKaLbYnLQ';
    const SHEET_NAME = 'DaftarPendaki';
    
    // METHOD 2: Via Apps Script API (Recommended - lebih aman)
    const USE_APPS_SCRIPT = true;
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/YOUR_APPS_SCRIPT_URL/exec';
    // GANTI URL di atas dengan URL deployment Apps Script kamu!
    
    let allData = [];
    let currentFilter = 'all';

    // Status mapping
    const statusConfig = {
      'CHECK-IN-NAIK': { class: 'status-naik', label: 'Check-in Naik' },
      'REST-BREAK': { class: 'status-rest', label: 'Istirahat' },
      'CAMPING-OVERNIGHT': { class: 'status-camping', label: 'Camping' },
      'SUMMIT-REACHED': { class: 'status-summit', label: 'Puncak' },
      'CHECK-OUT-EXIT': { class: 'status-exit', label: 'Check-out' },
      'CHECK-IN-TURUN': { class: 'status-turun', label: 'Turun' },
      'SOS-EMERGENCY': { class: 'status-sos', label: 'üö® SOS' }
    };

    // Load data dari Google Sheets
    async function loadData() {
      try {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('dataTable').style.display = 'none';
        document.getElementById('noData').style.display = 'none';

        let rows;

        if (USE_APPS_SCRIPT) {
          // METHOD 2: Via Apps Script API
          const response = await fetch(`${APPS_SCRIPT_URL}?dashboard=true`);
          const result = await response.json();
          
          if (!result.success) {
            throw new Error(result.error);
          }
          
          rows = result.data.map(row => ({
            hikername: row.hikername || '',
            nik: row.nik || '',
            groupname: row.groupname || 'Individu',
            uniqueid: row.uniqueid || '',
            statPos1: row.StatPos1 || '',
            timePos1: row.timePos1 || '',
            statPos2: row.StatPos2 || '',
            timePos2: row.timePos2 || '',
            statPos3: row.StatPos3 || '',
            timePos3: row.timePos3 || '',
            statPos4: row.StatPos4 || '',
            timePos4: row.timePos4 || '',
            statPos5: row.StatPos5 || '',
            timePos5: row.timePos5 || '',
            statPos6: row.StatPos6 || '',
            timePos6: row.timePos6 || '',
            latestActivity: row.LatestActivity || '',
            latestStatus: row.LatestStatus || ''
          }));
          
        } else {
          // METHOD 1: Langsung dari Google Sheets
          const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;
          const response = await fetch(url);
          const text = await response.text();
          
          // Parse Google Sheets JSON response
          const json = JSON.parse(text.substr(47).slice(0, -2));
          const sheetRows = json.table.rows;

          rows = sheetRows.map(row => ({
            hikername: row.c[2]?.v || '',
            nik: row.c[3]?.v || '',
            groupname: row.c[1]?.v || 'Individu',
            uniqueid: row.c[6]?.v || '',
            statPos1: row.c[7]?.v || '',
            timePos1: row.c[8]?.v || '',
            statPos2: row.c[9]?.v || '',
            timePos2: row.c[10]?.v || '',
            statPos3: row.c[11]?.v || '',
            timePos3: row.c[12]?.v || '',
            statPos4: row.c[13]?.v || '',
            timePos4: row.c[14]?.v || '',
            statPos5: row.c[15]?.v || '',
            timePos5: row.c[16]?.v || '',
            statPos6: row.c[17]?.v || '',
            timePos6: row.c[18]?.v || '',
            latestActivity: row.c[19]?.v || '',
            latestStatus: row.c[20]?.v || ''
          }));
        }

        allData = rows;
        updateStats();
        renderTable();

        document.getElementById('loading').style.display = 'none';

        if (allData.length === 0) {
          document.getElementById('noData').style.display = 'block';
        } else {
          document.getElementById('dataTable').style.display = 'table';
        }

      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('loading').innerHTML = `
          ‚ùå Error memuat data: ${error.message}<br><br>
          <strong>Troubleshooting:</strong><br>
          1. Pastikan Sheet sudah di-publish ke web<br>
          2. Pastikan Sheet ID sudah benar<br>
          3. Atau gunakan METHOD 2 (Apps Script API)
        `;
      }
    }

    // Update statistik
    function updateStats() {
      const stats = {
        total: allData.length,
        diJalur: 0,
        puncak: 0,
        istirahat: 0,
        sos: 0
      };

      allData.forEach(row => {
        const status = row.latestStatus;
        if (status === 'CHECK-IN-NAIK' || status === 'CHECK-IN-TURUN') stats.diJalur++;
        if (status === 'SUMMIT-REACHED') stats.puncak++;
        if (status === 'REST-BREAK' || status === 'CAMPING-OVERNIGHT') stats.istirahat++;
        if (status === 'SOS-EMERGENCY') stats.sos++;
      });

      document.getElementById('totalPendaki').textContent = stats.total;
      document.getElementById('diJalur').textContent = stats.diJalur;
      document.getElementById('puncak').textContent = stats.puncak;
      document.getElementById('istirahat').textContent = stats.istirahat;
      document.getElementById('sos').textContent = stats.sos;

      // Alert SOS
      if (stats.sos > 0) {
        showSOSAlert(stats.sos);
      }
    }

    // Show SOS Alert
    function showSOSAlert(count) {
      const sosData = allData.filter(r => r.latestStatus === 'SOS-EMERGENCY');
      const names = sosData.map(r => r.hikername).join(', ');
      
      // Play alert sound
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 1000;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
      } catch (e) {
        // Ignore audio errors
      }
    }

    // Render tabel
    function renderTable() {
      const searchTerm = document.getElementById('searchBox').value.toLowerCase();
      
      let filteredData = allData.filter(row => {
        const matchSearch = row.hikername.toLowerCase().includes(searchTerm) || 
                          row.nik.toLowerCase().includes(searchTerm);
        
        if (currentFilter === 'all') return matchSearch;
        if (currentFilter === 'active') {
          return matchSearch && (row.latestStatus === 'CHECK-IN-NAIK' || 
                                 row.latestStatus === 'CHECK-IN-TURUN' ||
                                 row.latestStatus === 'REST-BREAK' ||
                                 row.latestStatus === 'CAMPING-OVERNIGHT');
        }
        if (currentFilter === 'sos') {
          return matchSearch && row.latestStatus === 'SOS-EMERGENCY';
        }
        return matchSearch;
      });

      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      filteredData.forEach(row => {
        const tr = document.createElement('tr');
        
        // Pos tracker
        const posTracker = `
          <div class="pos-tracker">
            <div class="pos-dot ${row.statPos1 ? 'active' : ''}" title="Pos 1: ${row.statPos1 || 'Belum'}"></div>
            <div class="pos-dot ${row.statPos2 ? 'active' : ''}" title="Pos 2: ${row.statPos2 || 'Belum'}"></div>
            <div class="pos-dot ${row.statPos3 ? 'active' : ''}" title="Pos 3: ${row.statPos3 || 'Belum'}"></div>
            <div class="pos-dot ${row.statPos4 ? 'active' : ''}" title="Pos 4: ${row.statPos4 || 'Belum'}"></div>
            <div class="pos-dot ${row.statPos5 ? 'active' : ''}" title="Pos 5: ${row.statPos5 || 'Belum'}"></div>
            <div class="pos-dot ${row.statPos6 ? 'active' : ''}" title="Pos 6: ${row.statPos6 || 'Belum'}"></div>
          </div>
        `;

        const statusInfo = statusConfig[row.latestStatus] || { class: '', label: row.latestStatus || '-' };
        const statusBadge = row.latestStatus ? 
          `<span class="status-badge ${statusInfo.class}">${statusInfo.label}</span>` : '-';

        const timeFormatted = row.latestActivity ? 
          new Date(row.latestActivity).toLocaleString('id-ID') : '-';

        tr.innerHTML = `
          <td><strong>${row.hikername}</strong></td>
          <td><code>${row.nik}</code></td>
          <td>${row.groupname}</td>
          <td>${posTracker}</td>
          <td>${statusBadge}</td>
          <td>
            ${timeFormatted}
            <div class="time-info">${getTimeAgo(row.latestActivity)}</div>
          </td>
          <td><code style="font-size:10px;">${row.uniqueid}</code></td>
        `;
        
        tbody.appendChild(tr);
      });
    }

    // Helper: Time ago
    function getTimeAgo(timestamp) {
      if (!timestamp) return '';
      const now = new Date();
      const past = new Date(timestamp);
      const diffMs = now - past;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMins / 60);
      
      if (diffMins < 1) return 'Baru saja';
      if (diffMins < 60) return `${diffMins} menit lalu`;
      if (diffHours < 24) return `${diffHours} jam lalu`;
      return `${Math.floor(diffHours / 24)} hari lalu`;
    }

    // Export to CSV
    function exportToCSV() {
      const csv = [
        ['Nama', 'NIK', 'Kelompok', 'Status Terakhir', 'Waktu Terakhir', 'Unique ID'].join(','),
        ...allData.map(row => [
          row.hikername,
          row.nik,
          row.groupname,
          row.latestStatus,
          row.latestActivity,
          row.uniqueid
        ].join(','))
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `monitoring-pendaki-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Event listeners
    document.getElementById('searchBox').addEventListener('input', renderTable);

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentFilter = this.dataset.filter;
        renderTable();
      });
    });

    // Auto refresh setiap 30 detik
    setInterval(loadData, 30000);

    // Load pertama kali
    loadData();
  </script>
</body>
</html>
