<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Monitoring Pendakian</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background:#f0f2f5;
      padding:20px;
    }
    .header {
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:white; padding:30px; border-radius:15px;
      margin-bottom:30px; box-shadow:0 5px 15px rgba(0,0,0,0.2);
    }
    .header h1 { font-size:32px; margin-bottom:10px; }
    .header p { opacity:0.9; font-size:14px; }

    .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:30px; }
    .stat-card { background:white; padding:25px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); border-left:4px solid #667eea; }
    .stat-card.warning { border-left-color:#ffc107; }
    .stat-card.danger { border-left-color:#dc3545; }
    .stat-card.success { border-left-color:#28a745; }
    .stat-number { font-size:36px; font-weight:bold; color:#667eea; margin-bottom:5px; }
    .stat-label { color:#6c757d; font-size:14px; }

    .controls {
      background:white; padding:20px; border-radius:12px;
      margin-bottom:20px; box-shadow:0 2px 8px rgba(0,0,0,0.1);
      display:flex; gap:15px; align-items:center; flex-wrap:wrap;
    }
    .search-box { flex:1; min-width:250px; }
    .search-box input {
      width:100%; padding:10px 15px; border:2px solid #e0e0e0; border-radius:8px; font-size:14px;
    }
    .search-box input:focus { outline:none; border-color:#667eea; }
    .filter-btn { padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; transition:all .3s; }
    .filter-btn.active { background:#667eea; color:white; }
    .filter-btn:not(.active) { background:#e0e0e0; color:#666; }
    .refresh-btn { background:#28a745; color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }
    .export-btn { background:#17a2b8; color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }

    .table-container { background:white; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); overflow:hidden; }
    table { width:100%; border-collapse:collapse; }
    th { background:#667eea; color:white; padding:15px; text-align:left; font-weight:600; }
    td { padding:12px 15px; border-bottom:1px solid #e0e0e0; }
    tr:hover { background:#f8f9fa; }

    .status-badge { display:inline-block; padding:5px 12px; border-radius:15px; font-size:11px; font-weight:bold; }
    .status-naik{background:#d4edda;color:#155724;}
    .status-rest{background:#fff3cd;color:#856404;}
    .status-camping{background:#d1ecf1;color:#0c5460;}
    .status-summit{background:#e2d9f3;color:#6f42c1;}
    .status-exit{background:#e2e3e5;color:#383d41;}
    .status-turun{background:#ffeaa7;color:#d63031;}
    .status-sos{background:#f8d7da;color:#721c24;animation:blink 1s infinite;}
    @keyframes blink{0%,50%,100%{opacity:1;}25%,75%{opacity:0.6;}}
    .pos-tracker{display:flex;gap:5px;align-items:center;}
    .pos-dot{width:12px;height:12px;border-radius:50%;background:#e0e0e0;}
    .pos-dot.active{background:#28a745;box-shadow:0 0 0 3px rgba(40,167,69,0.3);}
    .loading{text-align:center;padding:50px;color:#667eea;font-size:18px;}
    .no-data{text-align:center;padding:50px;color:#999;}
    .time-info{font-size:11px;color:#999;}
  </style>
</head>
<body>
  <div class="header">
    <h1>üìä Dashboard Monitoring Pendakian</h1>
    <p>Real-time tracking semua pendaki ‚Ä¢ Update otomatis setiap 30 detik</p>
  </div>

  <div class="stats-grid" id="statsGrid">
    <div class="stat-card"><div class="stat-number" id="totalPendaki">-</div><div class="stat-label">Total Pendaki</div></div>
    <div class="stat-card success"><div class="stat-number" id="diJalur">-</div><div class="stat-label">Sedang di Jalur</div></div>
    <div class="stat-card"><div class="stat-number" id="puncak">-</div><div class="stat-label">Mencapai Puncak</div></div>
    <div class="stat-card warning"><div class="stat-number" id="istirahat">-</div><div class="stat-label">Istirahat/Camping</div></div>
    <div class="stat-card danger"><div class="stat-number" id="sos">-</div><div class="stat-label">‚ö†Ô∏è SOS Emergency</div></div>
  </div>

  <div class="controls">
    <div class="search-box"><input type="text" id="searchBox" placeholder="üîç Cari nama pendaki..."></div>
    <button class="filter-btn active" data-filter="all">Semua</button>
    <button class="filter-btn" data-filter="active">Aktif di Jalur</button>
    <button class="filter-btn" data-filter="sos">üÜò SOS</button>
    <button class="refresh-btn" onclick="loadData()">üîÑ Refresh</button>
    <button class="export-btn" onclick="exportToCSV()">üì• Export CSV</button>
  </div>

  <div class="table-container">
    <div class="loading" id="loading">‚è≥ Memuat data...</div>
    <div class="no-data" id="noData" style="display:none;">üì≠ Belum ada data pendaki</div>
    <table id="dataTable" style="display:none;">
      <thead>
        <tr>
          <th>Nama Pendaki</th>
          <th>Kelompok</th>
          <th>Progress Pos</th>
          <th>Status Terakhir</th>
          <th>Waktu Update</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <script>
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyKgkvB9lvlKBI_SXjiGaLGpCIUijmmXKprlMdn04k6GOkLsa1BvUJlAqyfRlX127PnvQ/exec';
    let allData = [];
    let currentFilter = 'all';

    const statusConfig = {
      'CHECK-IN-NAIK': { class:'status-naik', label:'Naik ‚¨ÜÔ∏è' },
      'REST-BREAK': { class:'status-rest', label:'Istirahat üõë' },
      'CAMPING-OVERNIGHT': { class:'status-camping', label:'Camping ‚õ∫' },
      'SUMMIT-REACHED': { class:'status-summit', label:'Puncak üèîÔ∏è' },
      'CHECK-IN-TURUN': { class:'status-turun', label:'Turun ‚¨áÔ∏è' },
      'CHECK-OUT-EXIT': { class:'status-exit', label:'Selesai üèÅ' },
      'SOS-EMERGENCY': { class:'status-sos', label:'üö® SOS' }
    };

    async function loadData(){
      try{
        document.getElementById('loading').style.display='block';
        document.getElementById('dataTable').style.display='none';
        document.getElementById('noData').style.display='none';

        const response = await fetch(`${APPS_SCRIPT_URL}?dashboard=true`);
        const result = await response.json();
        if(!result.success) throw new Error(result.error);
        allData = result.data.map(r=>({
          hikername:r.hikername||'',
          groupname:r.groupname||'Individu',
          latestStatus:r.LatestStatus||'',
          latestActivity:r.LatestActivity||'',
          ...r
        }));
        updateStats();
        renderTable();
        document.getElementById('loading').style.display='none';
        document.getElementById(allData.length?'dataTable':'noData').style.display=allData.length?'table':'block';
      }catch(err){
        document.getElementById('loading').innerHTML=`‚ùå Gagal memuat data: ${err.message}`;
      }
    }

    function updateStats(){
      const s={total:allData.length,diJalur:0,puncak:0,istirahat:0,sos:0};
      allData.forEach(r=>{
        const st=r.latestStatus;
        if(st==='CHECK-IN-NAIK'||st==='CHECK-IN-TURUN')s.diJalur++;
        if(st==='SUMMIT-REACHED')s.puncak++;
        if(st==='REST-BREAK'||st==='CAMPING-OVERNIGHT')s.istirahat++;
        if(st==='SOS-EMERGENCY')s.sos++;
      });
      document.getElementById('totalPendaki').textContent=s.total;
      document.getElementById('diJalur').textContent=s.diJalur;
      document.getElementById('puncak').textContent=s.puncak;
      document.getElementById('istirahat').textContent=s.istirahat;
      document.getElementById('sos').textContent=s.sos;
    }

    function renderTable(){
      const q=document.getElementById('searchBox').value.toLowerCase();
      let data=allData.filter(r=>r.hikername.toLowerCase().includes(q));
      if(currentFilter==='active')data=data.filter(r=>['CHECK-IN-NAIK','CHECK-IN-TURUN','REST-BREAK','CAMPING-OVERNIGHT'].includes(r.latestStatus));
      if(currentFilter==='sos')data=data.filter(r=>r.latestStatus==='SOS-EMERGENCY');

      const tbody=document.getElementById('tableBody'); tbody.innerHTML='';
      data.forEach(r=>{
        const posTracker=`<div class="pos-tracker">${
          Array.from({length:9},(_,i)=>`<div class="pos-dot ${r['StatPos'+(i+1)]?'active':''}" title="Pos ${i+1}: ${r['StatPos'+(i+1)]||'Belum'}"></div>`).join('')
        }</div>`;
        const info=statusConfig[r.latestStatus]||{class:'',label:r.latestStatus||'-'};
        const badge=`<span class="status-badge ${info.class}">${info.label}</span>`;
        const time=r.latestActivity?new Date(r.latestActivity).toLocaleString('id-ID',{dateStyle:'short',timeStyle:'short'}):'-';
        const rel=getTimeAgo(r.latestActivity);
        tbody.innerHTML+=`
          <tr>
            <td><strong>${r.hikername}</strong></td>
            <td>${r.groupname}</td>
            <td>${posTracker}</td>
            <td>${badge}</td>
            <td>${time}<div class="time-info">${rel}</div></td>
          </tr>`;
      });
    }

    function getTimeAgo(t){
      if(!t)return''; const n=new Date(), p=new Date(t), d=(n-p)/60000;
      if(d<1)return'Baru saja'; if(d<60)return`${Math.floor(d)} menit lalu`;
      const h=d/60; if(h<24)return`${Math.floor(h)} jam lalu`;
      return`${Math.floor(h/24)} hari lalu`;
    }

    function exportToCSV(){
      const csv=[['Nama','Kelompok','Status','Waktu'].join(','),
        ...allData.map(r=>[r.hikername,r.groupname,r.latestStatus,r.latestActivity].join(','))].join('\n');
      const blob=new Blob([csv],{type:'text/csv'}),url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url;a.download=`monitoring-${new Date().toISOString().split('T')[0]}.csv`;a.click();URL.revokeObjectURL(url);
    }

    document.getElementById('searchBox').addEventListener('input',renderTable);
    document.querySelectorAll('.filter-btn').forEach(b=>b.addEventListener('click',function(){
      document.querySelectorAll('.filter-btn').forEach(x=>x.classList.remove('active'));
      this.classList.add('active'); currentFilter=this.dataset.filter; renderTable();
    }));
    setInterval(loadData,30000);
    loadData();
  </script>
</body>
</html>
