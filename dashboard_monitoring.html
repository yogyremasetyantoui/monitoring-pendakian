<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Monitoring Pendakian</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background:#f0f2f5; padding:20px;
    }
    .header {
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:white; padding:30px; border-radius:15px;
      margin-bottom:30px; box-shadow:0 5px 15px rgba(0,0,0,0.2);
    }
    .header h1 { font-size:32px; margin-bottom:10px; }
    .header p { opacity:0.9; font-size:14px; }

    .stats-grid { 
      display:grid; 
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); 
      gap:20px; margin-bottom:30px; 
    }
    .stat-card { 
      background:white; padding:25px; border-radius:12px; 
      box-shadow:0 2px 8px rgba(0,0,0,0.1); border-left:4px solid #667eea; 
    }
    .stat-card.warning { border-left-color:#ffc107; }
    .stat-card.danger { border-left-color:#dc3545; }
    .stat-card.success { border-left-color:#28a745; }
    .stat-number { font-size:36px; font-weight:bold; color:#667eea; margin-bottom:5px; }
    .stat-label { color:#6c757d; font-size:14px; }

    .controls {
      background:white; padding:20px; border-radius:12px;
      margin-bottom:20px; box-shadow:0 2px 8px rgba(0,0,0,0.1);
      display:flex; gap:15px; align-items:center; flex-wrap:wrap;
    }
    .search-box { flex:1; min-width:250px; }
    .search-box input {
      width:100%; padding:10px 15px; border:2px solid #e0e0e0; 
      border-radius:8px; font-size:14px;
    }
    .search-box input:focus { outline:none; border-color:#667eea; }
    .filter-btn { 
      padding:10px 20px; border:none; border-radius:8px; 
      cursor:pointer; font-weight:bold; transition:all .3s; 
    }
    .filter-btn.active { background:#667eea; color:white; }
    .filter-btn:not(.active) { background:#e0e0e0; color:#666; }
    .refresh-btn { 
      background:#28a745; color:white; padding:10px 20px; 
      border:none; border-radius:8px; cursor:pointer; font-weight:bold; 
    }
    .export-btn { 
      background:#17a2b8; color:white; padding:10px 20px; 
      border:none; border-radius:8px; cursor:pointer; font-weight:bold; 
    }

    /* EMERGENCY ALERT SECTION */
    .emergency-section {
      background:#fff; border-radius:12px; padding:20px;
      margin-bottom:20px; box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    .emergency-header {
      display:flex; align-items:center; gap:10px;
      margin-bottom:15px; padding-bottom:10px;
      border-bottom:3px solid #dc3545;
    }
    .emergency-header h2 {
      color:#dc3545; font-size:20px; margin:0;
    }
    .emergency-stats {
      display:grid; grid-template-columns:repeat(4,1fr);
      gap:15px; margin-bottom:15px;
    }
    .emergency-stat {
      background:#f8f9fa; padding:15px; border-radius:8px;
      text-align:center; border-left:4px solid;
    }
    .emergency-stat.waspada { border-left-color:#ffc107; }
    .emergency-stat.siaga { border-left-color:#ff9800; }
    .emergency-stat.awas { border-left-color:#dc3545; }
    .emergency-stat.sos { border-left-color:#000; }
    .emergency-stat .number {
      font-size:28px; font-weight:bold; margin-bottom:5px;
    }
    .emergency-stat.waspada .number { color:#ffc107; }
    .emergency-stat.siaga .number { color:#ff9800; }
    .emergency-stat.awas .number { color:#dc3545; }
    .emergency-stat.sos .number { color:#000; }
    .emergency-stat .label {
      font-size:12px; color:#6c757d;
    }

    .emergency-table {
      width:100%; border-collapse:collapse;
    }
    .emergency-table th {
      background:#dc3545; color:white; padding:12px;
      text-align:left; font-size:13px;
    }
    .emergency-table td {
      padding:12px; border-bottom:1px solid #e0e0e0;
      font-size:13px;
    }
    .emergency-table tr:hover {
      background:#fff3cd;
    }
    .alert-badge {
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 12px; border-radius:20px; font-weight:bold;
      font-size:11px;
    }
    .alert-badge .dot {
      width:12px; height:12px; border-radius:50%;
      display:inline-block;
    }
    .alert-waspada { background:#fff3cd; color:#856404; }
    .alert-waspada .dot { background:#ffc107; animation:pulse-yellow 2s infinite; }
    .alert-siaga { background:#ffe5b4; color:#cc7a00; }
    .alert-siaga .dot { background:#ff9800; animation:pulse-orange 2s infinite; }
    .alert-awas { background:#f8d7da; color:#721c24; }
    .alert-awas .dot { background:#dc3545; animation:pulse-red 1.5s infinite; }
    .alert-sos { background:#d3d3d3; color:#000; }
    .alert-sos .dot { background:#000; animation:pulse-black 1s infinite; }

    @keyframes pulse-yellow {
      0%, 100% { box-shadow:0 0 0 0 rgba(255,193,7,0.7); }
      50% { box-shadow:0 0 0 8px rgba(255,193,7,0); }
    }
    @keyframes pulse-orange {
      0%, 100% { box-shadow:0 0 0 0 rgba(255,152,0,0.7); }
      50% { box-shadow:0 0 0 8px rgba(255,152,0,0); }
    }
    @keyframes pulse-red {
      0%, 100% { box-shadow:0 0 0 0 rgba(220,53,69,0.7); }
      50% { box-shadow:0 0 0 10px rgba(220,53,69,0); }
    }
    @keyframes pulse-black {
      0%, 100% { box-shadow:0 0 0 0 rgba(0,0,0,0.7); }
      50% { box-shadow:0 0 0 10px rgba(0,0,0,0); }
    }

    .delay-info {
      font-size:11px; color:#999; margin-top:3px;
    }
    .no-emergency {
      text-align:center; padding:30px; color:#28a745;
      font-size:16px; font-weight:bold;
    }

    /* MAIN TABLE */
    .table-container { 
      background:white; border-radius:12px; 
      box-shadow:0 2px 8px rgba(0,0,0,0.1); overflow:hidden; 
    }
    table { width:100%; border-collapse:collapse; }
    th { 
      background:#667eea; color:white; padding:15px; 
      text-align:left; font-weight:600; position:sticky; top:0; z-index:10;
    }
    td { padding:12px 15px; border-bottom:1px solid #e0e0e0; }
    tr:hover { background:#f8f9fa; }

    .status-badge { 
      display:inline-block; padding:5px 12px; border-radius:15px; 
      font-size:11px; font-weight:bold; 
    }
    .status-naik{background:#d4edda;color:#155724;}
    .status-rest{background:#fff3cd;color:#856404;}
    .status-camping{background:#d1ecf1;color:#0c5460;}
    .status-summit{background:#e2d9f3;color:#6f42c1;}
    .status-exit{background:#e2e3e5;color:#383d41;}
    .status-turun{background:#ffeaa7;color:#d63031;}
    .status-sos{background:#f8d7da;color:#721c24;animation:blink 1s infinite;}
    @keyframes blink{0%,50%,100%{opacity:1;}25%,75%{opacity:0.6;}}

    .pos-timeline {
      display:flex; align-items:center; gap:8px; padding:10px 0;
      overflow-x:auto;
    }
    .pos-item {
      display:flex; flex-direction:column; align-items:center;
      gap:5px; min-width:60px;
    }
    .pos-dot {
      width:24px; height:24px; border-radius:50%;
      background:#e0e0e0; border:3px solid #e0e0e0;
      display:flex; align-items:center; justify-content:center;
      font-size:10px; font-weight:bold; color:#999;
    }
    .pos-dot.active {
      background:#28a745; border-color:#28a745; color:white;
      box-shadow:0 0 0 4px rgba(40,167,69,0.2);
    }
    .pos-dot.current {
      background:#667eea; border-color:#667eea; color:white;
      box-shadow:0 0 0 4px rgba(102,126,234,0.3);
      animation:pulse 2s infinite;
    }
    .pos-dot.predicted {
      background:white; border:3px dashed #ff9800; color:#ff9800;
      box-shadow:0 0 0 4px rgba(255,152,0,0.1);
    }
    @keyframes pulse {
      0%, 100% { transform:scale(1); }
      50% { transform:scale(1.1); }
    }
    .pos-arrow {
      width:20px; height:2px; background:#ddd;
      position:relative;
    }
    .pos-arrow.active { background:#28a745; }
    .pos-arrow::after {
      content:''; position:absolute; right:-4px; top:-3px;
      width:0; height:0; border-left:8px solid #ddd;
      border-top:4px solid transparent;
      border-bottom:4px solid transparent;
    }
    .pos-arrow.active::after { border-left-color:#28a745; }
    .pos-label { font-size:10px; color:#666; text-align:center; white-space:nowrap; }
    .pos-time { font-size:9px; color:#999; text-align:center; }
    .prediction-badge {
      background:#ff9800; color:white; padding:2px 6px;
      border-radius:10px; font-size:9px; font-weight:bold; margin-top:2px;
    }
    .status-info { display:flex; flex-direction:column; gap:5px; }
    .status-main { font-weight:bold; color:#667eea; font-size:13px; }
    .loading{text-align:center;padding:50px;color:#667eea;font-size:18px;}
    .no-data{text-align:center;padding:50px;color:#999;}

    @media (max-width:768px) {
      .emergency-stats { grid-template-columns:repeat(2,1fr); }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìä Dashboard Monitoring Pendakian</h1>
    <p>Real-time tracking semua pendaki ‚Ä¢ Update otomatis setiap 30 detik</p>
  </div>

  <div class="stats-grid" id="statsGrid">
    <div class="stat-card">
      <div class="stat-number" id="totalPendaki">-</div>
      <div class="stat-label">Total Pendaki</div>
    </div>
    <div class="stat-card success">
      <div class="stat-number" id="diJalur">-</div>
      <div class="stat-label">Sedang di Jalur</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="puncak">-</div>
      <div class="stat-label">Mencapai Puncak</div>
    </div>
    <div class="stat-card warning">
      <div class="stat-number" id="istirahat">-</div>
      <div class="stat-label">Istirahat/Camping</div>
    </div>
    <div class="stat-card danger">
      <div class="stat-number" id="sos">-</div>
      <div class="stat-label">‚ö†Ô∏è SOS Emergency</div>
    </div>
  </div>

  <div class="controls">
    <div class="search-box">
      <input type="text" id="searchBox" placeholder="üîç Cari nama pendaki atau NIK...">
    </div>
    <button class="filter-btn active" data-filter="all">Semua</button>
    <button class="filter-btn" data-filter="active">Aktif di Jalur</button>
    <button class="filter-btn" data-filter="sos">üÜò SOS</button>
    <button class="refresh-btn" onclick="loadData()">üîÑ Refresh</button>
    <button class="export-btn" onclick="exportToCSV()">üì• Export CSV</button>
  </div>

  <!-- EMERGENCY ALERT SECTION -->
  <div class="emergency-section" id="emergencySection" style="display:none;">
    <div class="emergency-header">
      <h2>üö® MONITORING DARURAT</h2>
      <span style="color:#999;font-size:12px;">Pendaki yang melewati prediksi ETA</span>
    </div>
    
    <div class="emergency-stats">
      <div class="emergency-stat waspada">
        <div class="number" id="countWaspada">0</div>
        <div class="label">üü° Waspada<br>(Delay 1+ jam)</div>
      </div>
      <div class="emergency-stat siaga">
        <div class="number" id="countSiaga">0</div>
        <div class="label">üü† Siaga<br>(Delay 2+ jam)</div>
      </div>
      <div class="emergency-stat awas">
        <div class="number" id="countAwas">0</div>
        <div class="label">üî¥ Awas<br>(Delay 3+ jam)</div>
      </div>
      <div class="emergency-stat sos">
        <div class="number" id="countSOS">0</div>
        <div class="label">‚ö´ SOS<br>(Butuh Ranger)</div>
      </div>
    </div>

    <div id="emergencyTableContainer"></div>
  </div>

  <!-- MAIN DATA TABLE -->
  <div class="table-container">
    <div class="loading" id="loading">‚è≥ Memuat data...</div>
    <div class="no-data" id="noData" style="display:none;">
      üì≠ Belum ada data pendaki
    </div>
    <table id="dataTable" style="display:none;">
      <thead>
        <tr>
          <th>Nama Pendaki</th>
          <th>Kelompok</th>
          <th>Timeline Perjalanan (Pos 1-9)</th>
          <th>Status & Aktivitas</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <script>
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyKgkvB9lvlKBI_SXjiGaLGpCIUijmmXKprlMdn04k6GOkLsa1BvUJlAqyfRlX127PnvQ/exec';
    
    let allData = [];
    let currentFilter = 'all';
    const THREE_DAYS_MS = 3 * 24 * 60 * 60 * 1000;

    const posNames = {
      1: 'Pos 1', 2: 'Pos 2', 3: 'Pos 3', 4: 'Pos 4', 5: 'Pos 5',
      6: 'Pos 6', 7: 'Pos 7', 8: 'Pos 8', 9: 'Puncak'
    };

    const statusConfig = {
      'CHECK-IN-NAIK': { class:'status-naik', label:'üîº Naik' },
      'REST-BREAK': { class:'status-rest', label:'‚òï Istirahat' },
      'CAMPING-OVERNIGHT': { class:'status-camping', label:'‚õ∫ Camping' },
      'SUMMIT-REACHED': { class:'status-summit', label:'üèîÔ∏è Puncak' },
      'CHECK-IN-TURUN': { class:'status-turun', label:'üîΩ Turun' },
      'CHECK-OUT-EXIT': { class:'status-exit', label:'‚úÖ Selesai' },
      'SOS-EMERGENCY': { class:'status-sos', label:'üö® SOS' }
    };

    async function loadData(){
      try{
        document.getElementById('loading').style.display='block';
        document.getElementById('dataTable').style.display='none';
        document.getElementById('noData').style.display='none';

        const response = await fetch(`${APPS_SCRIPT_URL}?dashboard=true`);
        const result = await response.json();
        
        if(!result.success) throw new Error(result.error);
        
        const now = new Date();
        allData = result.data
          .map(r=>({
            hikername: r.hikername || '',
            nik: r.nik || '',
            groupname: r.groupname || 'Individu',
            uniqueid: r.uniqueid || '',
            latestStatus: r.LatestStatus || '',
            latestActivity: r.LatestActivity || '',
            StatPos1: r.StatPos1 || '', timePos1: r.timePos1 || '',
            StatPos2: r.StatPos2 || '', timePos2: r.timePos2 || '',
            StatPos3: r.StatPos3 || '', timePos3: r.timePos3 || '',
            StatPos4: r.StatPos4 || '', timePos4: r.timePos4 || '',
            StatPos5: r.StatPos5 || '', timePos5: r.timePos5 || '',
            StatPos6: r.StatPos6 || '', timePos6: r.timePos6 || '',
            StatPos7: r.StatPos7 || '', timePos7: r.timePos7 || '',
            StatPos8: r.StatPos8 || '', timePos8: r.timePos8 || '',
            StatPos9: r.StatPos9 || '', timePos9: r.timePos9 || '',
            PredPos1: r.PredPos1 || '', PredPos2: r.PredPos2 || '',
            PredPos3: r.PredPos3 || '', PredPos4: r.PredPos4 || '',
            PredPos5: r.PredPos5 || '', PredPos6: r.PredPos6 || '',
            PredPos7: r.PredPos7 || '', PredPos8: r.PredPos8 || '',
            PredPos9: r.PredPos9 || ''
          }))
          .filter(r => {
            // Filter: Sembunyikan CHECK-OUT lebih dari 3 hari
            if (r.latestStatus === 'CHECK-OUT-EXIT' && r.latestActivity) {
              const checkoutTime = new Date(r.latestActivity);
              const diffMs = now - checkoutTime;
              return diffMs <= THREE_DAYS_MS;
            }
            return true;
          });

        updateStats();
        renderEmergencySection();
        renderTable();
        
        document.getElementById('loading').style.display='none';
        document.getElementById(allData.length?'dataTable':'noData').style.display=allData.length?'table':'block';
      }catch(err){
        document.getElementById('loading').innerHTML=`‚ùå Gagal memuat data: ${err.message}`;
      }
    }

    function updateStats(){
      const s={total:allData.length,diJalur:0,puncak:0,istirahat:0,sos:0};
      allData.forEach(r=>{
        const st=r.latestStatus;
        if(st==='CHECK-IN-NAIK'||st==='CHECK-IN-TURUN')s.diJalur++;
        if(st==='SUMMIT-REACHED')s.puncak++;
        if(st==='REST-BREAK'||st==='CAMPING-OVERNIGHT')s.istirahat++;
        if(st==='SOS-EMERGENCY')s.sos++;
      });
      document.getElementById('totalPendaki').textContent=s.total;
      document.getElementById('diJalur').textContent=s.diJalur;
      document.getElementById('puncak').textContent=s.puncak;
      document.getElementById('istirahat').textContent=s.istirahat;
      document.getElementById('sos').textContent=s.sos;
    }

    function calculateAlertLevel(row) {
      const lastPos = getLastPos(row);
      const direction = getDirection(row);
      
      if (!lastPos || !direction || row.latestStatus === 'CHECK-OUT-EXIT') return null;
      
      const now = new Date();
      let nextPos = null;
      
      if (direction === 'NAIK' && lastPos.pos < 9) nextPos = lastPos.pos + 1;
      else if (direction === 'TURUN' && lastPos.pos > 1) nextPos = lastPos.pos - 1;
      
      if (!nextPos) return null;
      
      const predTime = row[`PredPos${nextPos}`];
      if (!predTime) return null;
      
      const prediction = new Date(predTime);
      const delayMs = now - prediction;
      const delayHours = delayMs / (1000 * 60 * 60);
      
      if (delayHours < 1) return null;
      
      // SOS Manual
      if (row.latestStatus === 'SOS-EMERGENCY') {
        return { level: 'SOS', delayHours, nextPos, predTime };
      }
      
      // Awas: 3+ jam
      if (delayHours >= 3) {
        return { level: 'AWAS', delayHours, nextPos, predTime };
      }
      
      // Siaga: 2+ jam
      if (delayHours >= 2) {
        return { level: 'SIAGA', delayHours, nextPos, predTime };
      }
      
      // Waspada: 1+ jam
      return { level: 'WASPADA', delayHours, nextPos, predTime };
    }

    function renderEmergencySection() {
      const emergencyData = allData
        .map(r => ({ ...r, alert: calculateAlertLevel(r) }))
        .filter(r => r.alert !== null)
        .sort((a, b) => {
          const priority = { SOS: 4, AWAS: 3, SIAGA: 2, WASPADA: 1 };
          return (priority[b.alert.level] || 0) - (priority[a.alert.level] || 0);
        });
      
      const counts = { WASPADA: 0, SIAGA: 0, AWAS: 0, SOS: 0 };
      emergencyData.forEach(r => counts[r.alert.level]++);
      
      document.getElementById('countWaspada').textContent = counts.WASPADA;
      document.getElementById('countSiaga').textContent = counts.SIAGA;
      document.getElementById('countAwas').textContent = counts.AWAS;
      document.getElementById('countSOS').textContent = counts.SOS;
      
      const section = document.getElementById('emergencySection');
      const container = document.getElementById('emergencyTableContainer');
      
      if (emergencyData.length === 0) {
        section.style.display = 'none';
        return;
      }
      
      section.style.display = 'block';
      
      let tableHTML = '<table class="emergency-table"><thead><tr>';
      tableHTML += '<th>Level Bahaya</th>';
      tableHTML += '<th>Nama Pendaki</th>';
      tableHTML += '<th>Kelompok</th>';
      tableHTML += '<th>Pos Terakhir</th>';
      tableHTML += '<th>Pos Tujuan</th>';
      tableHTML += '<th>Prediksi ETA</th>';
      tableHTML += '<th>Delay</th>';
      tableHTML += '</tr></thead><tbody>';
      
      emergencyData.forEach(r => {
        const lastPos = getLastPos(r);
        const alert = r.alert;
        
        let badgeClass = '';
        let badgeLabel = '';
        if (alert.level === 'WASPADA') {
          badgeClass = 'alert-waspada';
          badgeLabel = 'üü° WASPADA';
        } else if (alert.level === 'SIAGA') {
          badgeClass = 'alert-siaga';
          badgeLabel = 'üü† SIAGA';
        } else if (alert.level === 'AWAS') {
          badgeClass = 'alert-awas';
          badgeLabel = 'üî¥ AWAS';
        } else if (alert.level === 'SOS') {
          badgeClass = 'alert-sos';
          badgeLabel = '‚ö´ SOS';
        }
        
        tableHTML += '<tr>';
        tableHTML += `<td><span class="alert-badge ${badgeClass}"><span class="dot"></span>${badgeLabel}</span></td>`;
        tableHTML += `<td><strong>${r.hikername}</strong></td>`;
        tableHTML += `<td>${r.groupname}</td>`;
        tableHTML += `<td>${posNames[lastPos.pos]}<br><small style="color:#999;">${formatTime(lastPos.time)}</small></td>`;
        tableHTML += `<td><strong>${posNames[alert.nextPos]}</strong></td>`;
        tableHTML += `<td>${formatTime(alert.predTime)}</td>`;
        tableHTML += `<td><strong style="color:#dc3545;">+${Math.floor(alert.delayHours)}h ${Math.floor((alert.delayHours % 1) * 60)}m</strong></td>`;
        tableHTML += '</tr>';
      });
      
      tableHTML += '</tbody></table>';
      container.innerHTML = tableHTML;
    }

    function getLastPos(row) {
      for (let i = 9; i >= 1; i--) {
        if (row[`timePos${i}`]) {
          return {
            pos: i,
            status: row[`StatPos${i}`],
            time: row[`timePos${i}`]
          };
        }
      }
      return null;
    }

    function getDirection(row) {
      const lastPos = getLastPos(row);
      if (!lastPos) return null;
      
      const status = lastPos.status;
      if (/NAIK|SUMMIT|REST|CAMPING/i.test(status) && !/TURUN|EXIT/i.test(status)) {
        return 'NAIK';
      } else if (/TURUN|EXIT/i.test(status)) {
        return 'TURUN';
      }
      return null;
    }

    function renderTimeline(row) {
      const lastPos = getLastPos(row);
      const direction = getDirection(row);
      
      let html = '<div class="pos-timeline">';
      
      for (let i = 1; i <= 9; i++) {
        const hasPassed = row[`timePos${i}`] ? true : false;
        const isCurrent = lastPos && lastPos.pos === i;
        const predTime = row[`PredPos${i}`];
        const isPredicted = !hasPassed && predTime;
        
        let dotClass = '';
        let dotContent = i;
        if (isCurrent) dotClass = 'current';
        else if (hasPassed) dotClass = 'active';
        else if (isPredicted) dotClass = 'predicted';
        
        const actualTime = row[`timePos${i}`];
        const displayTime = actualTime ? formatTime(actualTime) : (isPredicted ? formatTime(predTime) : '');
        
        html += `<div class="pos-item">`;
        html += `<div class="pos-dot ${dotClass}">${dotContent}</div>`;
        html += `<div class="pos-label">${posNames[i]}</div>`;
        if (displayTime) html += `<div class="pos-time">${displayTime}</div>`;
        if (isPredicted) html += `<div class="prediction-badge">Prediksi</div>`;
        html += `</div>`;
        
        if (i < 9) {
          const arrowActive = hasPassed ? 'active' : '';
          html += `<div class="pos-arrow ${arrowActive}"></div>`;
        }
      }
      
      html += '</div>';
      return html;
    }

    function formatTime(timeStr) {
      if (!timeStr) return '';
      const d = new Date(timeStr);
      return d.toLocaleString('id-ID', { 
        day: '2-digit', 
        month: 'short', 
        hour: '2-digit', 
        minute: '2-digit' 
      });
    }

    function renderTable(){
      const q=document.getElementById('searchBox').value.toLowerCase();
      let data=allData.filter(r=>
        r.hikername.toLowerCase().includes(q) || 
        r.nik.toLowerCase().includes(q)
      );
      
      if(currentFilter==='active') {
        data=data.filter(r=>['CHECK-IN-NAIK','CHECK-IN-TURUN','REST-BREAK','CAMPING-OVERNIGHT'].includes(r.latestStatus));
      }
      if(currentFilter==='sos') {
        data=data.filter(r=>r.latestStatus==='SOS-EMERGENCY');
      }

      const tbody=document.getElementById('tableBody'); 
      tbody.innerHTML='';
      
      data.forEach(r=>{
        const timeline = renderTimeline(r);
        const info = statusConfig[r.latestStatus] || {class:'', label:r.latestStatus||'-'};
        const badge = `<span class="status-badge ${info.class}">${info.label}</span>`;
        
        const lastPos = getLastPos(r);
        const lastPosName = lastPos ? posNames[lastPos.pos] : '-';
        const lastTime = lastPos ? formatTime(lastPos.time) : '-';
        const timeAgo = lastPos ? getTimeAgo(lastPos.time) : '';
        
        const direction = getDirection(r);
        let nextPrediction = '';
        if (direction === 'NAIK' && lastPos && lastPos.pos < 9) {
          const nextPos = lastPos.pos + 1;
          const predTime = r[`PredPos${nextPos}`];
          if (predTime) {
            nextPrediction = `<div style="color:#ff9800;font-size:11px;margin-top:5px;">
              üìç Prediksi ${posNames[nextPos]}: ${formatTime(predTime)}
            </div>`;
          }
        } else if (direction === 'TURUN' && lastPos && lastPos.pos > 1) {
          const nextPos = lastPos.pos - 1;
          const predTime = r[`PredPos${nextPos}`];
          if (predTime) {
            nextPrediction = `<div style="color:#ff9800;font-size:11px;margin-top:5px;">
              üìç Prediksi ${posNames[nextPos]}: ${formatTime(predTime)}
            </div>`;
          }
        }
        
        tbody.innerHTML+=`
          <tr>
            <td><strong>${r.hikername}</strong></td>
            <td>${r.groupname}</td>
            <td>${timeline}</td>
            <td>
              <div class="status-info">
                <div class="status-main">${lastPosName}</div>
                ${badge}
                <div style="font-size:11px;color:#999;">Update: ${lastTime}</div>
                <div style="font-size:10px;color:#bbb;">${timeAgo}</div>
                ${nextPrediction}
              </div>
            </td>
          </tr>`;
      });
    }

    function getTimeAgo(t){
      if(!t)return''; 
      const n=new Date(), p=new Date(t), d=(n-p)/60000;
      if(d<1)return'Baru saja'; 
      if(d<60)return`${Math.floor(d)} menit lalu`;
      const h=d/60; 
      if(h<24)return`${Math.floor(h)} jam lalu`;
      return`${Math.floor(h/24)} hari lalu`;
    }

    function exportToCSV(){
      const csv=[
        ['Nama','Kelompok','Status','Pos Terakhir','Waktu','Prediksi Berikutnya','Alert Level','Delay'].join(','),
        ...allData.map(r=>{
          const lastPos = getLastPos(r);
          const lastPosName = lastPos ? posNames[lastPos.pos] : '-';
          const lastTime = lastPos ? formatTime(lastPos.time) : '-';
          
          const direction = getDirection(r);
          let pred = '-';
          let alertInfo = '';
          let delayInfo = '';
          
          if (direction === 'NAIK' && lastPos && lastPos.pos < 9) {
            const nextPos = lastPos.pos + 1;
            pred = r[`PredPos${nextPos}`] ? `${posNames[nextPos]}: ${formatTime(r[`PredPos${nextPos}`])}` : '-';
          } else if (direction === 'TURUN' && lastPos && lastPos.pos > 1) {
            const nextPos = lastPos.pos - 1;
            pred = r[`PredPos${nextPos}`] ? `${posNames[nextPos]}: ${formatTime(r[`PredPos${nextPos}`])}` : '-';
          }
          
          const alert = calculateAlertLevel(r);
          if (alert) {
            alertInfo = alert.level;
            delayInfo = `+${Math.floor(alert.delayHours)}h ${Math.floor((alert.delayHours % 1) * 60)}m`;
          }
          
          return [r.hikername, r.groupname, r.latestStatus, lastPosName, lastTime, pred, alertInfo, delayInfo].join(',');
        })
      ].join('\n');
      
      const blob=new Blob([csv],{type:'text/csv'}),url=URL.createObjectURL(blob);
      const a=document.createElement('a'); 
      a.href=url;
      a.download=`monitoring-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById('searchBox').addEventListener('input',renderTable);
    document.querySelectorAll('.filter-btn').forEach(b=>b.addEventListener('click',function(){
      document.querySelectorAll('.filter-btn').forEach(x=>x.classList.remove('active'));
      this.classList.add('active'); 
      currentFilter=this.dataset.filter; 
      renderTable();
    }));
    
    setInterval(loadData,30000);
    loadData();
  </script>
</body>
</html>
